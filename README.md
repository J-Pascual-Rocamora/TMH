# Readme
Developer: Javier Pascual Rocamora

To run the code, you will need a running RabbitMQ instance and python 3.
If you are a docker user, you could install one with the line:
```sh
docker run -d --hostname flask-rabbit --name flask-rabbit -p 4369:4369 -p 5671:5671 -p 5672:5672 rabbitmq:3
```

All the depencies used by the code are in the requirements.txt file.
You can install them with pip:
```bash
pip install -r requirements.txt
```

If you are more fan of virtualenvironments, install a virtual environment, activate it and install dependencies:
```
virtualenv -python=python3 env
source env/bin/activate
pip install -r requirements
```

Once you have your depencies intalled and the environment activated, you can run the code with:
```bash
python main.py
```

Please note that the code assumes that RabbitMQ is running in port 5672. If you already had a RabbitMQ instance running in some other port, you can tell the code with the -p flag:
```bash
python main.py -p port_number
```

The code can run in to different modes, real time simulation and simulated time simulation.
The real time simulation will run with the wall clock, while the simulated time will have a counter to simulate the clock.
The idea is that you can obtain a whole day data in few seconds. The default mode is simulated time. To run in the real time mode use the -R flag:
```bash
python main.py -R
```

You can combine both flags if desired. You can also see the script help by running:
```bash
python main.py --h
```

To stop the code simply click CTRL+C. The code will close all the RabbitMQ instances.

# Tests
You can run the tests from within the virtualenvironment with the command:
```bash
python -m pytest tests.py
```

# Output
The output is saved into a CSV file. The file has five columns:

* Time stamp
* Meter reading value in Watts
* Photovoltaic predicted value in Watts
* Meter + Photovoltaic value in Watts
* Net power value in Watts

Note that the net power value is calculated by substracting the power consumed by the house from the power generated by the photovoltaic system.


# Model Discussion

## Home system
The home function is simulated as a step function. Here appliances are connected and disconnected every 3 hours.
This is represented with a random number generator, which changes its value every 3 hours and is always in between 0 and 9000.

## Photovoltaic system
The model is based in solar radiation data obtained from:
https://re.jrc.ec.europa.eu/pvg_tools/en/tools.html#DR

The data can be found in the file radiation_data.csv.
The curve is affected by weather conditions, reader geolocation and time of the year.
Since no data about those variables has been provided, a random location and date has been choosen.
Since the platform only provides one measurement per hour, a polynomial of order three has been fitted to the data in order to obtain a continuous function.
Then the values have been scaled to obtain a maximum value of 3.25, similar to the maximum power value of the given graph.

It is understood that the two slope functions, before and after the "bell", represent a time of the day when either there is no direct sun incident on the cells or part of the installation is cover with shadows.
These shadows might been cast by nearby objects, or the system itself, and due to the sun position.
In order to reproduce these lines, an educated guess has been taken to set the time when system is under "direct" sunlight and when there is no sunlight.

We can say that in our model, there is sunlight between 5.30 and 17.00 and the system is under direct sunlight from 7.15 until 15.40.

The given example shows some noise all over the curve, and accentuated between 12.00 and 16.00. It is understood that this noise can be caused by multiple things, such as clouds passing by.
To reproduce this noise...

## Model improvements
The model has been based on little data obtained for a photovoltaic system with two axis mounted type. 
Having a different mounted type might produce those slopes that were created artificially.
Also, having the date and the geolocation of the reader, the actual times of sunrise, down and sunlight could have been found.
More data points would also help improving the model.
Also noise could be added to represent the non-ideal functionality of a photovoltaic system.